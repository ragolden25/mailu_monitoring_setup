# Generated by mailu_monitoring_setup
services:
  redis:
    image: redis:alpine
    restart: always
    volumes:
      - "/opt/mailu/redis:/data"
    depends_on: [resolver]
    dns: [172.18.255.254]

  front:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}nginx:{{ pm_mailu_version }}
    restart: always
    env_file: /opt/mailu/mailu.env
    logging:
      driver: journald
      options: { tag: mailu-front }
    ports:
      - "{{ pm_bind_ip }}:80:80"
      - "{{ pm_bind_ip }}:443:443"
      - "{{ pm_bind_ip }}:25:25"
      - "{{ pm_bind_ip }}:465:465"
      - "{{ pm_bind_ip }}:587:587"
      - "{{ pm_bind_ip }}:110:110"
      - "{{ pm_bind_ip }}:995:995"
      - "{{ pm_bind_ip }}:143:143"
      - "{{ pm_bind_ip }}:993:993"
      - "{{ pm_bind_ip }}:4190:4190"
    networks: [default, webmail, radicale]
    volumes:
      - "/opt/mailu/certs:/certs"
      - "/opt/mailu/overrides/nginx:/overrides:ro"
    depends_on: [resolver]
    dns: [172.18.255.254]

  resolver:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}unbound:{{ pm_mailu_version }}
    env_file: /opt/mailu/mailu.env
    logging:
      driver: journald
      options: { tag: mailu-resolver }
    restart: always
    networks:
      default:
        ipv4_address: 172.18.255.254

  admin:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}admin:{{ pm_mailu_version }}
    restart: always
    env_file: /opt/mailu/mailu.env
    logging:
      driver: journald
      options: { tag: mailu-admin }
    volumes:
      - "/opt/mailu/data:/data"
      - "/opt/mailu/dkim:/dkim"
    depends_on: [redis, resolver]
    dns: [172.18.255.254]

  imap:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}dovecot:{{ pm_mailu_version }}
    restart: always
    env_file: /opt/mailu/mailu.env
    logging:
      driver: journald
      options: { tag: mailu-imap }
    volumes:
      - "/opt/mailu/mail:/mail"
      - "/opt/mailu/overrides/dovecot:/overrides:ro"
    networks: [default, fts_attachments]
    depends_on: [front, fts_attachments, resolver]
    dns: [172.18.255.254]

  smtp:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}postfix:{{ pm_mailu_version }}
    restart: always
    env_file: /opt/mailu/mailu.env
    logging:
      driver: journald
      options: { tag: mailu-smtp }
    volumes:
      - "/opt/mailu/mailqueue:/queue"
      - "/opt/mailu/overrides/postfix:/overrides:ro"
    depends_on: [front, resolver]
    dns: [172.18.255.254]

  oletools:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}oletools:{{ pm_mailu_version }}
    hostname: oletools
    logging:
      driver: journald
      options: { tag: mailu-oletools }
    restart: always
    networks: [oletools]
    depends_on: [resolver]
    dns: [172.18.255.254]

  fts_attachments:
    image: apache/tika:2.9.2.1-full
    hostname: tika
    logging:
      driver: journald
      options: { tag: mailu-tika }
    restart: always
    networks: [fts_attachments]
    depends_on: [resolver]
    dns: [172.18.255.254]
    healthcheck:
      test: ["CMD-SHELL", "wget -nv -t1 -O /dev/null http://127.0.0.1:9998/tika || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  antispam:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}rspamd:{{ pm_mailu_version }}
    hostname: antispam
    restart: always
    env_file: /opt/mailu/mailu.env
    logging:
      driver: journald
      options: { tag: mailu-antispam }
    networks: [default, oletools, clamav]
    volumes:
      - "/opt/mailu/filter:/var/lib/rspamd"
      - "/opt/mailu/overrides/rspamd:/overrides:ro"
    depends_on: [front, redis, oletools, antivirus, resolver]
    dns: [172.18.255.254]

  antivirus:
    image: clamav/clamav-debian:1.4
    restart: always
    logging:
      driver: journald
      options: { tag: mailu-antivirus }
    networks: [clamav]
    volumes:
      - "/opt/mailu/clamav:/var/lib/clamav"
    healthcheck:
      test: ["CMD-SHELL", "kill -0 `cat /tmp/clamd.pid` && kill -0 `cat /tmp/freshclam.pid`"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  webdav:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}radicale:{{ pm_mailu_version }}
    restart: always
    logging:
      driver: journald
      options: { tag: mailu-webdav }
    volumes:
      - "/opt/mailu/dav:/data"
    networks: [radicale]

  webmail:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}webmail:{{ pm_mailu_version }}
    restart: always
    env_file: /opt/mailu/mailu.env
    logging:
      driver: journald
      options: { tag: mailu-webmail }
    volumes:
      - "/opt/mailu/webmail:/data"
      - "/opt/mailu/overrides/roundcube:/overrides:ro"
    networks: [webmail]
    depends_on: [front]

networks:
  default:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: {{ pm_subnet }}
  radicale:
    driver: bridge
  webmail:
    driver: bridge
  clamav:
    driver: bridge
  oletools:
    driver: bridge
    internal: true
  fts_attachments:
    driver: bridge
    internal: true
